# 微服务鉴权方案设计

### 一条理念

不应对功能做任何的限制或缩小，应当提供最大范围内的支持。如前后端鉴权，不应限制只能同时操纵一个用户，应支持多用户的操作。只要提供相应用户的权限证明，就可以获得改用户的信息。换言之，用户的数据只是上了锁，只要持有相应的钥匙，就可以获取相应的数据。

即，对于应用服务器来说，只需判断当前请求的权限，而无需验证请求者的身份。

提出一种通行证的概念，作为权限的载体。

### 认证服务器功能

- 注册
  - 注册信息
    - 用户名、邮箱、手机号、密码
  - 注册方式
    - 密码、验证码、第三方注册
  - 用户表定义
    - id,username,email,phone_number,password_hash,confirmed
- 登录（同域）

  - 登录方式
    - 密码、验证码、第三方登录

- 认证（跨域认证、第三方认证）
  - OAuth2+jwt

### 用户表设计

- id,username,email,phone_number,password_hash,confirmed

### 请求流程

- 前端
  - 认证检查：判断 local storage 中 是否存在通行证、向后端查询通行证是否有效（失败则跳转至认证页面，并附带跳转链接）
  - 发起请求：向后端发起请求，附带通行证
- 网关
  - 提取 jwt（若无返回无权限）
  - 验证 jwt（若失败返回无权限）
  - 将 jwt 中的信息放入 http-headers 中
- 资源服务器：
  - 权限验证：从 http-headers 中提取用户和权限信息等(鉴权失败则返回错误信息或错误页面)
  - 返回资源：资源服务器处理业务或返回资源

### 认证流程

- 前端

  - 认证检查：前端初始化时，检测不存在通行证或通行证校验失败，跳转至授权页面（回转地址：应用自定义的回转地址，二次回转地址：应用使用页面）
  - 主站点授权页面：进行登录检查、检查是否登录主站点（未登录则进跳转登录页面，回转地址：授权页面），若已登录，则执行授权流程
  - 主站点登录页面：若上一步检查出尚未登录，则跳转此页面执行登录流程（完成后跳转：授权页面）
  - 授权流程：
    - 用户在前端表单中进行授权，提交到后端。
    - 后端校验用户是否登录（未登录返回错误页面），已登录则生成通行证。
    - 后端将通信证作为参数附加到应用回转地址中，返回 http 跳转使浏览器跳转至回转地址(这样原二次跳转地址即应用使用页面，变成了一次跳转地址)。
  - 应用回转地址：后端按需保存通行证，并返回一个含脚本的页面，将通行证保存在浏览器 local storage 中。保存完成后跳转应用使用页面。
  - 使用页面：使用 local storage 中的通行证请求资源。

### 参考

- [OAuth2.0 协议入门（二）：OAuth2.0 授权服务端从设计到实现](https://juejin.cn/post/6844903668861534215)
- [微服务实战（一）基于 OAUTH2.0 统一认证授权的微服务基础架构](https://blog.csdn.net/w1054993544/article/details/78932614)
- [微服务统⼀认证⽅案 Spring Cloud OAuth2 + JWT](https://juejin.cn/post/6855302923996856334)

```

```
